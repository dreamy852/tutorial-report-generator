<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial Record Management</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .records-container {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .records-table th {
            background: var(--primary-blue);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        
        .records-table th:hover {
            background: var(--primary-blue-dark);
        }
        
        .records-table th.sortable::after {
            content: ' ↕';
            opacity: 0.5;
        }
        
        .records-table th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
        }
        
        .records-table th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
        }
        
        .records-table tr:hover {
            background: var(--bg-light);
        }
        
        .delete-btn {
            background: var(--error);
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .form-container {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-field textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        
        .form-field textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-field input[type="time"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .btn-danger {
            background: var(--error);
            color: var(--white);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .ai-enhance-comment-btn {
            margin-top: 5px;
            padding: 6px 12px;
            background: var(--accent-blue);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .ai-enhance-comment-btn:hover {
            background: var(--primary-blue-light);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            font-style: italic;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: var(--text-light);
            color: var(--white);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input-label:hover {
            background: var(--text-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">Tutorial Record Management</h1>
        </header>

        <!-- Records Table Section -->
        <div class="records-container">
            <h2 class="section-title">Records</h2>
            <div id="recordsTableContainer">
                <table class="records-table" id="recordsTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="teacher">Teacher</th>
                            <th class="sortable" data-sort="student">Student</th>
                            <th class="sortable" data-sort="date">Date</th>
                            <th class="sortable" data-sort="startTime">Start Time</th>
                            <th class="sortable" data-sort="endTime">End Time</th>
                            <th>Comment</th>
                            <th>Additional Remark</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <tr>
                            <td colspan="8" class="empty-state">No records yet. Add your first record below.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Form Section -->
        <div class="form-container">
            <h2 class="section-title">Add New Record</h2>
            <form id="recordForm">
                <div class="form-row">
                    <div class="form-field">
                        <label for="teacherSelect">Teacher Name *</label>
                        <select id="teacherSelect" name="teacherSelect" required>
                            <option value="">-- Please select teacher --</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label for="studentSelect">Student Name *</label>
                        <select id="studentSelect" name="studentSelect" required disabled>
                            <option value="">-- Please select teacher first --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-field">
                        <label for="recordDate">Date *</label>
                        <input type="date" id="recordDate" name="recordDate" required>
                    </div>
                    
                    <div class="form-field">
                        <label for="startTime">Start Time * (hh:mm)</label>
                        <input type="time" id="startTime" name="startTime" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-field">
                        <label for="endTime">End Time * (hh:mm)</label>
                        <input type="time" id="endTime" name="endTime" required>
                    </div>
                </div>
                
                <div class="form-field">
                    <label for="comment">Comment *</label>
                    <textarea id="comment" name="comment" required></textarea>
                    <button type="button" class="ai-enhance-comment-btn" onclick="enhanceComment()">Enhance with AI (Grammar/Word Choice)</button>
                </div>
                
                <div class="form-field">
                    <label for="additionalRemark">Additional Remark (Optional)</label>
                    <textarea id="additionalRemark" name="additionalRemark"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Record</button>
                    <button type="button" class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
                    <label for="csvFileInput" class="file-input-label btn btn-secondary">Import CSV</label>
                    <input type="file" id="csvFileInput" accept=".csv" onchange="importCSV(event)">
                    <button type="button" class="btn btn-danger" onclick="deleteAllRecords()">Delete All</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Storage key
        const STORAGE_KEY = 'tutorial_records';
        const TEACHERS_STORAGE_KEY = 'tutorial_teachers_data';
        
        // Global variables
        let records = [];
        let teachersData = {};
        let currentSort = { field: null, direction: 'asc' };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTeachersData();
            loadRecords();
            initializeForm();
            setDefaultDate();
            renderTable();
        });
        
        // Load teachers data from localStorage or Google Sheets
        async function loadTeachersData() {
            // Try to load from localStorage first
            const stored = localStorage.getItem(TEACHERS_STORAGE_KEY);
            if (stored) {
                try {
                    teachersData = JSON.parse(stored);
                    populateTeacherDropdown();
                    return;
                } catch (e) {
                    console.warn('Failed to parse teachers data from localStorage');
                }
            }
            
            // If not in localStorage, try to load from Google Sheets (from app.js)
            try {
                const googleSheetId = '1M4mRBujj-mx4eHHNl55RrgfA-SqVLaVoubnQ58MmKLU';
                const url = `https://docs.google.com/spreadsheets/d/${googleSheetId}/gviz/tq?tqx=out:json`;
                const response = await fetch(url);
                const text = await response.text();
                const jsonText = text.substring(47, text.length - 2);
                const data = JSON.parse(jsonText);
                
                teachersData = {};
                if (data.table && data.table.rows) {
                    const rows = data.table.rows;
                    const cols = data.table.cols;
                    
                    let teacherColIndex = -1;
                    let studentNameColIndex = -1;
                    let subjectColIndex = -1;
                    let classGradeColIndex = -1;
                    
                    // Find column indices
                    cols.forEach((col, index) => {
                        const label = (col.label || '').toString().toLowerCase();
                        if (label.includes('教師') || label.includes('teacher')) {
                            teacherColIndex = index;
                        } else if (label.includes('學生姓名') || label.includes('student name') || (label.includes('學生') && !label.includes('教師'))) {
                            studentNameColIndex = index;
                        } else if (label.includes('科目') || label.includes('subject')) {
                            subjectColIndex = index;
                        } else if (label.includes('班級') || label.includes('年級') || label.includes('class') || label.includes('grade')) {
                            classGradeColIndex = index;
                        }
                    });
                    
                    // Parse data rows
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i].c;
                        if (!row) continue;
                        
                        const teacher = teacherColIndex >= 0 && row[teacherColIndex] ? (row[teacherColIndex].v || '').toString().trim() : '';
                        const studentName = studentNameColIndex >= 0 && row[studentNameColIndex] ? (row[studentNameColIndex].v || '').toString().trim() : '';
                        const subject = subjectColIndex >= 0 && row[subjectColIndex] ? (row[subjectColIndex].v || '').toString().trim() : '';
                        const classGrade = classGradeColIndex >= 0 && row[classGradeColIndex] ? (row[classGradeColIndex].v || '').toString().trim() : '';
                        
                        if (teacher && studentName) {
                            if (!teachersData[teacher]) {
                                teachersData[teacher] = [];
                            }
                            teachersData[teacher].push({
                                name: studentName,
                                subject: subject,
                                classGrade: classGrade
                            });
                        }
                    }
                }
                
                // Save to localStorage
                localStorage.setItem(TEACHERS_STORAGE_KEY, JSON.stringify(teachersData));
                populateTeacherDropdown();
            } catch (error) {
                console.error('Failed to load teachers data:', error);
                // Use empty data
                teachersData = {};
                populateTeacherDropdown();
            }
        }
        
        // Populate teacher dropdown
        function populateTeacherDropdown() {
            const teacherSelect = document.getElementById('teacherSelect');
            if (!teacherSelect) return;
            
            const currentValue = teacherSelect.value;
            teacherSelect.innerHTML = '<option value="">-- Please select teacher --</option>';
            
            const teachers = [...new Set(Object.keys(teachersData))].sort();
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                teacherSelect.appendChild(option);
            });
            
            if (currentValue) {
                teacherSelect.value = currentValue;
            }
            
            // Add event listener
            teacherSelect.addEventListener('change', function() {
                handleTeacherSelection(this.value);
            });
        }
        
        // Handle teacher selection
        function handleTeacherSelection(teacherValue) {
            const studentSelect = document.getElementById('studentSelect');
            
            if (teacherValue) {
                populateStudentDropdown(teacherValue);
                studentSelect.disabled = false;
            } else {
                studentSelect.disabled = true;
                studentSelect.innerHTML = '<option value="">-- Please select teacher first --</option>';
            }
        }
        
        // Populate student dropdown
        function populateStudentDropdown(teacherName) {
            const studentSelect = document.getElementById('studentSelect');
            if (!studentSelect) return;
            
            const currentValue = studentSelect.value;
            studentSelect.innerHTML = '<option value="">-- Please select student --</option>';
            
            const students = teachersData[teacherName] || [];
            students.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = index.toString();
                option.textContent = `${student.name}_${student.classGrade}_${student.subject}`;
                studentSelect.appendChild(option);
            });
            
            if (currentValue) {
                studentSelect.value = currentValue;
            }
        }
        
        // Initialize form
        function initializeForm() {
            const form = document.getElementById('recordForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                addRecord();
            });
        }
        
        // Set default date to today
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
        }
        
        // Load records from localStorage
        function loadRecords() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    records = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse records from localStorage:', e);
                    records = [];
                }
            } else {
                records = [];
            }
        }
        
        // Save records to localStorage
        function saveRecords() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            } catch (e) {
                console.error('Failed to save records to localStorage:', e);
                alert('Failed to save records. Storage may be full.');
            }
        }
        
        // Add new record
        function addRecord() {
            const teacherSelect = document.getElementById('teacherSelect');
            const studentSelect = document.getElementById('studentSelect');
            const recordDate = document.getElementById('recordDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const comment = document.getElementById('comment').value.trim();
            const additionalRemark = document.getElementById('additionalRemark').value.trim();
            
            // Validate
            if (!teacherSelect.value || !studentSelect.value || !recordDate || !startTime || !endTime || !comment) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Validate time format
            if (!/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/.test(startTime) || !/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/.test(endTime)) {
                alert('Please enter valid time in hh:mm format.');
                return;
            }
            
            // Validate end time is after start time
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            if (end <= start) {
                alert('End time must be after start time.');
                return;
            }
            
            // Get teacher and student names
            const teacherName = teacherSelect.value;
            const studentIndex = parseInt(studentSelect.value);
            const students = teachersData[teacherName] || [];
            const student = students[studentIndex];
            
            if (!student) {
                alert('Invalid student selection.');
                return;
            }
            
            // Create record
            const record = {
                id: Date.now().toString(),
                teacher: teacherName,
                student: student.name,
                date: recordDate,
                startTime: startTime,
                endTime: endTime,
                comment: comment,
                additionalRemark: additionalRemark || ''
            };
            
            records.push(record);
            saveRecords();
            renderTable();
            
            // Reset form
            document.getElementById('recordForm').reset();
            setDefaultDate();
            studentSelect.disabled = true;
            studentSelect.innerHTML = '<option value="">-- Please select teacher first --</option>';
            
            alert('Record added successfully!');
        }
        
        // Delete record
        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                records = records.filter(r => r.id !== id);
                saveRecords();
                renderTable();
            }
        }
        
        // Delete all records
        function deleteAllRecords() {
            if (confirm('Are you sure you want to delete ALL records? This action cannot be undone.')) {
                records = [];
                saveRecords();
                renderTable();
                alert('All records deleted.');
            }
        }
        
        // Sort table
        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            records.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle date sorting
                if (field === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                // Handle time sorting
                if (field === 'startTime' || field === 'endTime') {
                    aVal = new Date(`2000-01-01T${aVal}`);
                    bVal = new Date(`2000-01-01T${bVal}`);
                }
                
                if (aVal < bVal) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (aVal > bVal) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            renderTable();
        }
        
        // Render table
        function renderTable() {
            const tbody = document.getElementById('recordsTableBody');
            if (!tbody) return;
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No records yet. Add your first record below.</td></tr>';
                return;
            }
            
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${escapeHtml(record.teacher)}</td>
                    <td>${escapeHtml(record.student)}</td>
                    <td>${escapeHtml(record.date)}</td>
                    <td>${escapeHtml(record.startTime)}</td>
                    <td>${escapeHtml(record.endTime)}</td>
                    <td>${escapeHtml(record.comment.substring(0, 50))}${record.comment.length > 50 ? '...' : ''}</td>
                    <td>${escapeHtml(record.additionalRemark.substring(0, 50))}${record.additionalRemark.length > 50 ? '...' : ''}</td>
                    <td><button class="delete-btn" onclick="deleteRecord('${record.id}')">Delete</button></td>
                </tr>
            `).join('');
            
            // Update sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort.field) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        // Export to CSV
        function exportCSV() {
            if (records.length === 0) {
                alert('No records to export.');
                return;
            }
            
            // CSV header
            const headers = ['Teacher', 'Student', 'Date', 'Start Time', 'End Time', 'Comment', 'Additional Remark'];
            const csvRows = [headers.join(',')];
            
            // CSV rows
            records.forEach(record => {
                const row = [
                    escapeCSV(record.teacher),
                    escapeCSV(record.student),
                    escapeCSV(record.date),
                    escapeCSV(record.startTime),
                    escapeCSV(record.endTime),
                    escapeCSV(record.comment),
                    escapeCSV(record.additionalRemark)
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tutorial_records_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Import from CSV
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file must have at least a header row and one data row.');
                        return;
                    }
                    
                    // Parse header
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    // Expected headers
                    const expectedHeaders = ['Teacher', 'Student', 'Date', 'Start Time', 'End Time', 'Comment', 'Additional Remark'];
                    if (headers.length < expectedHeaders.length) {
                        alert('CSV file format is incorrect. Expected headers: ' + expectedHeaders.join(', '));
                        return;
                    }
                    
                    // Parse data rows
                    const importedRecords = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        if (values.length >= 6) {
                            const record = {
                                id: Date.now().toString() + '_' + i,
                                teacher: values[0] || '',
                                student: values[1] || '',
                                date: values[2] || '',
                                startTime: values[3] || '',
                                endTime: values[4] || '',
                                comment: values[5] || '',
                                additionalRemark: values[6] || ''
                            };
                            
                            // Validate record
                            if (record.teacher && record.student && record.date && record.startTime && record.endTime && record.comment) {
                                importedRecords.push(record);
                            }
                        }
                    }
                    
                    if (importedRecords.length === 0) {
                        alert('No valid records found in CSV file.');
                        return;
                    }
                    
                    // Merge with existing records
                    records = records.concat(importedRecords);
                    saveRecords();
                    renderTable();
                    
                    alert(`Successfully imported ${importedRecords.length} record(s).`);
                    
                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    console.error('Error importing CSV:', error);
                    alert('Failed to import CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Parse CSV line (handles quoted values)
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            
            return values;
        }
        
        // Escape CSV value
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }
        
        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Enhance comment with AI
        async function enhanceComment() {
            const commentField = document.getElementById('comment');
            const currentContent = commentField.value.trim();
            
            if (!currentContent) {
                alert('Please enter some content first before enhancing with AI.');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Enhancing...';
            
            try {
                const enhancedText = await enhanceTextWithDeepSeek(currentContent, 'en');
                
                if (enhancedText) {
                    commentField.value = enhancedText;
                    alert('Comment enhanced successfully!');
                }
            } catch (error) {
                console.error('AI Enhancement error:', error);
                alert('Failed to enhance comment: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // AI Enhancement function (using DeepSeek API)
        async function enhanceTextWithDeepSeek(textSection, language = 'en') {
            const API_KEY = 'sk-0fdaddd9f0db4e70821938381de23af6';
            const API_URL = 'https://api.deepseek.com/v1/chat/completions';
            
            if (!textSection || textSection.trim().length === 0) {
                throw new Error('Text section cannot be empty');
            }
            
            const prompt = `As an experienced teacher, improve this comment for grammar and word choice. Write ONLY plain text (no bold, italic, underline, headers, or formatting). Keep the original meaning and tone. Original text: ${textSection}`;
            
            const systemMessage = 'You are an experienced teacher and educational writer. Your task is to improve comments for grammar and word choice only. IMPORTANT: Return ONLY plain text with no formatting. Maintain the original meaning and tone while improving clarity and professionalism.';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: systemMessage
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500,
                        top_p: 0.95
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API error (${response.status}): ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from API');
                }
                
                let enhancedText = data.choices[0].message.content.trim();
                
                if (!enhancedText) {
                    throw new Error('Empty response from API');
                }
                
                // Strip any formatting
                enhancedText = enhancedText
                    .replace(/\*\*(.*?)\*\*/g, '$1')
                    .replace(/\*(.*?)\*/g, '$1')
                    .replace(/__(.*?)__/g, '$1')
                    .replace(/_([^_]+)_/g, '$1')
                    .replace(/#{1,6}\s*(.*?)$/gm, '$1')
                    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
                    .replace(/<[^>]+>/g, '')
                    .trim();
                
                return enhancedText;
                
            } catch (error) {
                console.error('DeepSeek API error:', error);
                throw error;
            }
        }
        
        // Add click handlers for sortable columns
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    sortTable(this.dataset.sort);
                });
            });
        });
    </script>
</body>
</html>